name: Telegram Bot Scanner

# ВАЖНО: Для работы в GitHub Actions требуется предварительная авторизация
# 1. Запустите бот локально для создания session файла
# 2. Закодируйте в base64: base64 telegram_scanner.session > session.txt
# 3. Добавьте содержимое как GitHub Secret: TELEGRAM_SESSION_BASE64

on:
  # Запуск по расписанию (каждый день в 00:00 UTC)
  schedule:
    - cron: '0 0 * * *'
  
  # Запуск вручную через GitHub Actions UI
  workflow_dispatch:
    inputs:
      days_back:
        description: 'Количество дней для сканирования'
        required: false
        default: '7'

jobs:
  scan-chats:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Restore Telegram Session
      if: ${{ secrets.TELEGRAM_SESSION_BASE64 }}
      run: |
        if [ -n "${{ secrets.TELEGRAM_SESSION_BASE64 }}" ]; then
          echo "${{ secrets.TELEGRAM_SESSION_BASE64 }}" | base64 -d > telegram_scanner.session
          echo "Session file restored"
        fi
    
    - name: Run Telegram Bot Scanner
      env:
        TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
        TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
        TELEGRAM_PHONE: ${{ secrets.TELEGRAM_PHONE }}
        SESSION_NAME: telegram_scanner
        OUTPUT_FILE: results.csv
        DAYS_BACK: ${{ github.event.inputs.days_back || '7' }}
      run: |
        python bot.py
    
    - name: Upload results to Google Drive
      if: success()
      env:
        GDRIVE_SERVICE_ACCOUNT_JSON: ${{ secrets.GDRIVE_SERVICE_ACCOUNT_JSON }}
        GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
      run: |
        if [ -n "$GDRIVE_SERVICE_ACCOUNT_JSON" ]; then
          python upload_to_gdrive.py --file results.csv
        else
          echo "GDRIVE_SERVICE_ACCOUNT_JSON not set, skipping upload"
        fi
    
    - name: Upload results as artifact
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: telegram-scan-results
        path: results.csv
        retention-days: 30
